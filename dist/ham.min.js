define("/common",["lodash","superagent","async","exports"],function(a,b,c,d){"use strict";function e(){var a=n.extend({},{_backlog:[],queue:null,send:function(b){a.queue?a.queue.push(b):a._backlog.push(b)},bind:function(b){a.queue=p.queue(function(a,c){b(a),c()}),a.queue.push(a._backlog),a._backlog=null},close:function(){a.closed||(a.queue=null,a._backlog=null,a.closed=!0,a.onClose())},onClose:function(){}});return a}function f(a,b){var c=a.href;return n.each(b,function(a,b){c=c.replace("{"+b+"}",a,"g")}),c}function g(a){var b=a.href,c=b.match(s),d=[];return b=b.replace("/","\\/","g"),n.each(c,function(a){b=b.replace(a,"([^\\/]*)"),d.push(a.substr(1,a.length-2))}),[new RegExp(b),d]}function h(a){var b=g(a),c=b[0],d=b[1];return function(a){var b=n.rest(a.match(c)),e={};return n.each(b,function(a,b){e[d[b]]=a}),n.size(e)&&e||null}}function i(a,b,c){var d=n.first(b),e=n.rest(b);e.length?(null==a[d]&&(a[d]={}),i(a[d],e,c)):a[d]=c}function j(a,b){var c=n.first(b),d=n.rest(b);if(d.length){if(null==a[c])return;j(a[c],d)}else delete a[c]}function k(a,b){var c=n.first(b),d=n.rest(b);if(d.length){if(null==a[c])return;return k(a[c],d)}return a[c]}function l(a,b,c,d,e){var f=o(b,a).withCredentials().type("json").accept("json").set(c).redirects(0);return d&&("GET"==b||"HEAD"==b||"OPTIONS"==b?f.query(d):f.send(JSON.stringify(d))),f.end(e),f}function m(a,b,c,d,e){function f(a){a.status>=300&&a.status<400&&a.headers.Location?(307!=a.status&&(b="GET"),l(a.headers.Location,b,c,null,e)):e(a)}return l(a,b,c,d,f)}var n=a["default"]||a,o=b["default"]||b,p=c["default"]||c,q=function(){var a=[];return a.push.apply(a,arguments),a.__proto__=q.prototype,a};d.MetaArray=q,q.prototype=new Array,q.prototype.setMeta=function(a){this.__meta=n.extend({}||this.__meta,a)},q.prototype.getMeta=function(){return this.__meta||{}};var r=function(){var a=n.extend({},arguments[0]||{});return a.__proto__=r.prototype,a};d.MetaObject=r,r.prototype=new Object,r.prototype.setMeta=function(a){this.__meta=n.extend({}||this.__meta,a)},r.prototype.getMeta=function(){return this.__meta||{}},d.Channel=e;var s=/\{([^\{\}]*)\}/g;d.urlTemplatePattern=s,d.renderUrl=f,d.renderUrlRegexp=g,d.renderUrlMatcher=h,d.assocIn=i,d.dissocIn=j,d.getIn=k,d.doRequest=m}),define("/ham",["lodash","./common","exports"],function(a,b,c){"use strict";function d(a){return e.extend({},o,{cacheTime:3e5,schemas:{},objects:{},recycle_bin:{},channels:{},schema_sources:{},resolveInstancesUrlFromDetailUrl:function(a){var b=this,c=null,d=null;return e.each(this.schemas,function(e){if(c)return!1;var f=b.getLink(e,{rel:"full",method:"GET"}),g=b.getLink(e,{rel:"instances",method:"GET"});if(f&&g){var h=j(f),i=h(a);if(i)return c=g,d=i,!1}}),c?g(c,d):!1},updateCache:function(a){var b=this.getMeta(a),c=b.uri;if(this.objects[c]=a,"DELETE"==b.action){l(this.objects,[c]);var d=this.resolveInstancesUrlFromDetailUrl(c),f=this.objects[d];if(f){var h=this.rootObject(f),i=this.getLink(f,{rel:"full",method:"GET"}),j=this.splitURIptr(this.getMeta(h).uri);h=e.filter(h,function(a){return g(i,a)!=c}),e.size(j)?k(f,j,h):f=h,this.publishDocument(f,!0)}}else if("GET"==b.action){var d=this.resolveInstancesUrlFromDetailUrl(c),f=this.objects[d];if(f){var h=this.rootObject(f),m=this.rootObject(a);h.push(m),this.publishDocument(f,!0)}}},sendCache:function(a,b,c,d){var e=m(this.objects,[a,b,c]);if(e){d.send(e);var f=(new Date).getTime()-this.getMeta(e).timestamp;if("GET"==b&&f<this.cacheTime)return!0}return!1},populateSchemasFromUri:function(a){var b=f(),c=this;return n(a,"GET",this.headers,null,function(d){var f=c.parseResponse(d);c.schema_sources[a]=f,e.each(f,function(b,d){c.registerSchema(d,b),c.registerSchema(a+"#/"+d,b)}),b.send(f)}),b}},a)}var e=a["default"]||a,f=b.Channel,g=b.renderUrl,h=b.MetaArray,i=b.MetaObject,j=b.renderUrlMatcher,k=b.assocIn,l=b.dissocIn,m=b.getIn,n=b.doRequest,o={regexProfileURI:/.*;.*profile\=([A-Za-z0-9\-_\/\#]+).*/,rootLink:function(a){return this.getLink(a,{rel:"root"})},splitURIptr:function(a){return a?e.filter(e.last(a.split("#",2)).split("/")):[]},setMeta:function(a,b){if(a instanceof h||a instanceof i)return a.setMeta(b),a;if(a instanceof Array){var c=new h;return c.push.apply(c,a),c.setMeta(b),c}if(a instanceof Object){var c=new i(a);return c.setMeta(b),c}if(null==a){var c=new i;return c.setMeta(b),c}console.log("Unrecognized",a)},getMeta:function(a){return a.getMeta&&a.getMeta()||{}},subObject:function(a,b){var c=this.splitURIptr(b),d=this.getMeta(a),e=m(a,c);return e=this.setMeta(e,{timestamp:d.timestamp,uri:d.uri+b})},rootObject:function(a){var b=this.rootLink(a);if(b){var c=this.subObject(a,b.href);return c.__meta.rel="root",c}return a},getDocument:function(a,b,c,d,e){return this.streamDocument(a,b,c,d,function(a){return e&&e(a),!1})},streamDocument:function(a,b,c,d,e){var f=this.openChannel(a,b,c,d);return f.bind(e),f},openChannel:function(a,b,c,d){var e=this.getLink(a,b),h=g(e,c),i=e.method&&e.method.toUpperCase()||"GET",j=f();return this.subscribeURI(h,i,d,j),j},registerSchema:function(a,b){this.schemas[a]=b},getSchema:function(a){return this.schemas[a]},getLink:function(a,b){var c=null;if("string"==typeof a){var d=this.getSchema(a);d?c=d.links:console.log("failed to find schema:",a,this.schemas)}else{var d=this.getMeta(a).schema||{};c=e.merge([],d.links,a.links)}return c=e.where(c,b),e.size(c)>1,e.first(c)},subscribeURI:function(a,b,c,d){var f=this,g="GET"==b&&this.sendCache(a,d),h=e.uniqueId();g||this.callURI(a,b,c,d.send),k(this.channels,[a,h],d),d.onClose=function(){l(f.channels,[a,h])}},parseResponse:function(a){if(console.log("parsing response:",a),a.error)throw error;var b=(a.req.url,a.req.method),c=a.body;if(c=this.setMeta(c,{timestamp:(new Date).getTime(),uri:a.req.url,action:b}),a.profile){var d=this.getSchema(a.profile);c.setMeta({schema:d,schema_url:a.profile})}return c},callURI:function(a,b,c,d){var e=this;n(a,b,e.headers,c,function(a){var b=e.parseResponse(a);e.publishDocument(b),d&&d(b)})},publishDocument:function(a,b){if(b||this.checkSuccess(a)){var c=this.getMeta(a);this.updateCache(a),e.each(this.channels[c.uri],function(b){b.send(a),"DELETE"==c.action&&b.close()})}},checkSuccess:function(){return!0},updateCache:function(){},sendCache:function(){},headers:{}};c.Ham=d}),define("ham",["/ham"],function(a){return a});