define("/common",["lodash","superagent","exports"],function(a,b,c){"use strict";function d(a,b){var c=a.href;return k.each(b,function(a,b){c=c.replace("{"+b+"}",a,"g")}),c}function e(a){var b=a.href,c=b.match(o),d=[];return b=b.replace("/","\\/","g"),k.each(c,function(a){b=b.replace(a,"([^\\/]*)"),d.push(a.substr(1,a.length-2))}),[new RegExp("^"+b+"$"),d]}function f(a){var b=e(a),c=b[0],d=b[1];return function(a){var b=k.rest(a.match(c)),e={};return k.each(b,function(a,b){e[d[b]]=a}),k.size(e)&&e||null}}function g(a,b,c){var d=k.first(b),e=k.rest(b);e.length?(null==a[d]&&(a[d]={}),g(a[d],e,c)):a[d]=c}function h(a,b){var c=k.first(b),d=k.rest(b);if(d.length){if(null==a[c])return;h(a[c],d)}else delete a[c]}function i(a,b){var c=k.first(b),d=k.rest(b);if(d.length){if(null==a[c])return;return i(a[c],d)}return a[c]}function j(a,b,c,d,e,f){b=b&&b.toUpperCase()||"GET",c=c||{},c.accept=c.accept||"application/json",c["Content-Type"]=c["Content-Type"]||"application/json";var g=[],h=l(b,a).on("redirect",function(a){g.push(a.headers.location)}).set(c);return h.withCredentials&&(h=h.withCredentials()),d&&("GET"==b||"HEAD"==b||"OPTIONS"==b?h.query(d):h.send(JSON.stringify(d))),h.end(function(a){a.redirects=g,a.ok?e(a):f(a)}),h}var k=a["default"]||a,l=b["default"]||b,m=function(){var a=[];return a.push.apply(a,arguments),a.__proto__=m.prototype,a};c.MetaArray=m,m.prototype=new Array,m.prototype.setMeta=function(a){this.__meta=k.extend(this.__meta||{},a)},m.prototype.getMeta=function(){return this.__meta||{}};var n=function(){var a=k.extend({},arguments[0]||{});return a.__proto__=n.prototype,a};c.MetaObject=n,n.prototype=new Object,n.prototype.setMeta=function(a){this.__meta=k.extend(this.__meta||{},a)},n.prototype.getMeta=function(){return this.__meta||{}};var o=/\{([^\{\}]*)\}/g;c.urlTemplatePattern=o,c.renderUrl=d,c.renderUrlRegexp=e,c.renderUrlMatcher=f,c.assocIn=g,c.dissocIn=h,c.getIn=i,c.doRequest=j}),define("/ham",["lodash","postal","postal.request-response","./common","exports"],function(a,b,c,d,e){"use strict";function f(a){return g.extend({schemas:{},objects:{},recycle_bin:{},schema_sources:{}},r,s,a)}var g=a["default"]||a,h=b["default"]||b,i=c["default"]||c,j=d.renderUrl,k=d.MetaArray,l=d.MetaObject,m=d.renderUrlMatcher,n=d.assocIn,o=d.dissocIn,p=d.getIn,q=d.doRequest;g.isFunction(i)&&i(h);var r={baseURI:"",channel:"ham",timeout:5e3,regexProfileURI:/.*;.*profile\=([A-Za-z0-9\-_\/\#]+).*/,rootLink:function(a){return this.getLink(a,{rel:"root"})},splitURIptr:function(a){if(!a)return[];var b=a.split("#",2)[1];return b?g.filter(b.split("/")):[]},setMeta:function(a,b){if(a instanceof k||a instanceof l)return a.setMeta(b),a;if(a instanceof Array){var c=new k;return c.push.apply(c,a),c.setMeta(b),c}if(a instanceof Object){var c=new l(a);return c.setMeta(b),c}if(null==a){var c=new l;return c.setMeta(b),c}console.log("Unrecognized",a)},getMeta:function(a){return a.getMeta&&a.getMeta()||{}},subObject:function(a,b){var c=this.splitURIptr(b),d=this.getMeta(a),e=p(a,c);return e=this.setMeta(e,{timestamp:d.timestamp,action:d.action,uri:d.uri+b})},rootObject:function(a){var b=this.rootLink(a);if(b){var c=this.subObject(a,b.href);return this.setMeta(c,{rel:"root"}),c}return a},getDocument:function(a,b,c,d,e,f){var g=this.openChannel(a,b,c,d,!0);return e?g.then(e,f):g},streamDocument:function(a,b,c,d,e,f){var g=this.openChannel(a,b,c,d,!1);return e?g.then(e,f):g},setupResponses:function(){g.isString(this.channel)&&(this.channel=h.channel(this.channel));var a=this;this.setupResponsesDone=this.channel.subscribe("open",function(b,c){var d=!1;"GET"==b.method&&(d=a.sendCache(b.url,b.payload)),d?c.reply(null,d):a.callURI(b.url,b.method,b.payload).then(g.partial(c.reply,null),c.reply)})},openChannel:function(a,b,c,d,e){this.setupResponsesDone||this.setupResponses();var f=this,g=this.getLink(a,b),h=j(g,c),i=g.method&&g.method.toUpperCase()||"GET";this.baseURI&&"/"==h[0]&&(h=this.baseURI+h);var k={then:function(a,b){function c(b){a(b)===!1&&g.unsubscribe()}b=b?b:"undefined"==typeof window?console.error:window.onerror||console.error;var g=f.channel.subscribe("document:"+h,function(){});return f.channel.request({topic:"open",data:{url:h,payload:d,method:i},timeout:f.timeout}).then(function(b){null!==b&&(a(b)===!1||e)?g.unsubscribe():g.subscribe(c)},function(a){g.unsubscribe(),b(a)}),e?g.once():g}};return k},registerSchema:function(a,b){this.schemas[a]=b},getSchema:function(a){return this.schemas[a]},getLink:function(a,b){var c=null;if("string"==typeof a){var d=this.getSchema(a);d?c=d.links:console.log("failed to find schema:",a,b)}else{var d=this.getMeta(a).schema||{};c=g.merge([],d.links,a.links)}return c=g.transform(c,function(a,c){g.every(b,function(a,b){return"string"==typeof a?c[b].toLowerCase()==a.toLowerCase():c[b]==a})&&a.push(c)}),g.size(c)>1,g.first(c)},getURI:function(a,b,c){return j(this.getLink(a,b),c)},parseResponse:function(a){if(a.error)throw a.error;var b=a.headers.uri||a.headers.location||a.req.url,c=a.req.method;a.headers.length&&(b=a.headers[a.headers.length-1],"DELETE"!=c&&(c="GET"));var d=a.body;if(d=this.setMeta(d,{timestamp:(new Date).getTime(),uri:b,action:c}),a.profile){var e=this.getSchema(a.profile);d.setMeta({schema:e,schema_url:a.profile})}return d},callURI:function(a,b,c){var d=this,e=h.configuration.promise.createDeferred();return q(a,b,d.headers,c,function(a){var b=d.parseResponse(a);d.publishDocument(b),e.resolve(b)},function(a){e.reject(a.text)}),h.configuration.promise.getPromise(e)},publishDocument:function(a,b){if(b||this.checkSuccess(a)){{this.getMeta(a)}this.updateCache(a),this.notifySubscribers(a)}},checkSuccess:function(){return!0},notifySubscribers:function(a){this.setupResponsesDone||this.setupResponses();var b=this.getMeta(a).uri;this.channel.publish({topic:"document:"+b,data:a})},updateCache:function(){},sendCache:function(){return!1},headers:{}};e.HamProcessor=r;var s={cacheTime:3e5,resolveInstancesUrlFromDetailUrl:function(a){var b=this,c=null,d=null;return g.each(this.schemas,function(e){if(c)return!1;var f=b.getLink(e,{rel:"full",method:"GET"}),g=b.getLink(e,{rel:"instances",method:"GET"});if(f&&g){var h=m(f),i=h(a);if(i)return c=g,d=i,!1}}),c?j(c,d):!1},updateCache:function(a){var b=this.getMeta(a),c=b.uri;if("DELETE"==b.action){o(this.objects,[c]);var d=this.resolveInstancesUrlFromDetailUrl(c),e=this.objects[d];if(e){var f=this.rootObject(e),h=this.getLink(e,{rel:"full",method:"GET"}),i=this.splitURIptr(this.getMeta(f).uri);f=g.filter(f,function(a){return j(h,a)!=c}),g.size(i)?n(e,i,f):e=this.setMeta(f,this.getMeta(e)),this.publishDocument(e,!0)}}else if("GET"==b.action||"PATCH"==b.action||"POST"==b.action||"PUT"==b.action){this.objects[c]=a;var d=this.resolveInstancesUrlFromDetailUrl(c),e=this.objects[d];if(e){var f=this.rootObject(e),h=this.getLink(e,{rel:"full",method:"GET"}),i=this.splitURIptr(this.getMeta(f).uri),k=this.rootObject(a),l=!0;f=g.transform(f,function(a,b){j(h,b)==c?(a.push(k),l=!1):a.push(b)}),l&&f.push(k),g.size(i)?n(e,i,f):e=this.setMeta(f,this.getMeta(e)),this.publishDocument(e,!0)}}},sendCache:function(a,b){if(b)return!1;var c=this.objects[a];if(c){var d=(new Date).getTime()-this.getMeta(c).timestamp;if(d<this.cacheTime)return c}return!1},populateSchemasFromUri:function(a){var b=this,c=h.configuration.promise.createDeferred();return q(a,"GET",this.headers,null,function(d){var e=b.parseResponse(d);b.schema_sources[a]=e,e=g.transform(e,function(a,b,c){"object"==typeof b&&(a[c]=b)}),g.each(e,function(c,d){b.registerSchema(d,c),b.registerSchema(a+"#/"+d,c)}),c.resolve(e)}),h.configuration.promise.getPromise(c)}};e.HamCacher=s,e.Ham=f}),define("ham",["/ham"],function(a){return a});